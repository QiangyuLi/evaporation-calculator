<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Nomograph for Sprinkler Evaporation Loss</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .slider-track {
            background: #e5e7eb;
        }
        .slider-thumb {
            background: #3b82f6;
        }
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        .slider-thumb::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Interactive Nomograph</h1>
            <p class="text-lg text-gray-600 mt-2">For Estimating Sprinkler Evaporation Loss</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Input Controls Column -->
            <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6 border-b pb-4">Input Parameters</h2>
                <div class="space-y-6">
                    <!-- Vapor-Pressure Deficit -->
                    <div>
                        <label for="vpd" class="flex justify-between items-center text-sm font-medium text-gray-700">
                            <span>Vapor-Pressure Deficit (psi)</span>
                            <span id="vpd-value" class="font-bold text-blue-600">0.60 psi</span>
                        </label>
                        <input id="vpd" type="range" min="0" max="1" value="0.6" step="0.01" class="w-full h-2 rounded-lg appearance-none cursor-pointer slider-track slider-thumb">
                    </div>
                    <!-- Nozzle Diameter -->
                    <div>
                        <label for="nozzle" class="flex justify-between items-center text-sm font-medium text-gray-700">
                            <span>Nozzle Diameter (in)</span>
                            <span id="nozzle-value" class="font-bold text-blue-600">3/16"</span>
                        </label>
                        <input id="nozzle" type="range" min="8" max="64" value="12" class="w-full h-2 rounded-lg appearance-none cursor-pointer slider-track slider-thumb">
                    </div>
                    <!-- Nozzle Pressure -->
                    <div>
                        <label for="pressure" class="flex justify-between items-center text-sm font-medium text-gray-700">
                            <span>Nozzle Pressure (psi)</span>
                            <span id="pressure-value" class="font-bold text-blue-600">40 psi</span>
                        </label>
                        <input id="pressure" type="range" min="20" max="80" value="40" class="w-full h-2 rounded-lg appearance-none cursor-pointer slider-track slider-thumb">
                    </div>
                    <!-- Wind Velocity -->
                    <div>
                        <label for="wind" class="flex justify-between items-center text-sm font-medium text-gray-700">
                            <span>Wind Velocity (mph)</span>
                            <span id="wind-value" class="font-bold text-blue-600">5 mph</span>
                        </label>
                        <input id="wind" type="range" min="0" max="15" value="5" class="w-full h-2 rounded-lg appearance-none cursor-pointer slider-track slider-thumb">
                    </div>
                </div>
                 <div class="mt-8 pt-6 border-t">
                    <h3 class="text-xl font-bold text-center">Result</h3>
                    <div class="mt-4 bg-blue-50 p-4 rounded-lg text-center">
                        <p class="text-lg text-gray-700">Percent Evaporation Loss:</p>
                        <p id="result-text" class="text-4xl font-extrabold text-blue-600">14.5%</p>
                    </div>
                </div>
            </div>

            <!-- Nomograph Canvas Column -->
            <div class="lg:col-span-2 bg-white p-2 md:p-4 rounded-2xl shadow-lg relative" style="height: 650px;">
                <canvas id="nomographCanvas"></canvas>
            </div>
        </div>

        <footer class="text-center mt-8 text-sm text-gray-500">
            <p>Based on the Frost and Schwalen nomograph. This is a digital representation for estimation purposes.</p>
        </footer>
    </div>

    <script>
        // --- DOM Element Selection ---
        const canvas = document.getElementById('nomographCanvas');
        const ctx = canvas.getContext('2d');
        const parentDiv = canvas.parentElement;

        const vpdSlider = document.getElementById('vpd');
        const nozzleSlider = document.getElementById('nozzle');
        const pressureSlider = document.getElementById('pressure');
        const windSlider = document.getElementById('wind');

        const vpdValueSpan = document.getElementById('vpd-value');
        const nozzleValueSpan = document.getElementById('nozzle-value');
        const pressureValueSpan = document.getElementById('pressure-value');
        const windValueSpan = document.getElementById('wind-value');
        const resultText = document.getElementById('result-text');

        // --- Nomograph Configuration ---
        const config = {
            padding: { top: 50, bottom: 50, left: 40, right: 40 },
            font: '12px Inter',
            labelFont: 'bold 14px Inter',
            lineColor: '#9ca3af', // gray-400
            tickColor: '#6b7280', // gray-500
            textColor: '#374151', // gray-700
            pivotColor: '#1f2937', // gray-800
            line1Color: 'rgba(239, 68, 68, 0.8)', // red-500
            line2Color: 'rgba(59, 130, 246, 0.8)', // blue-500
            line3Color: 'rgba(22, 163, 74, 0.9)', // green-600
            markerColor: '#be123c', // rose-700
        };

        let canvasWidth, canvasHeight;
        let scales = {};

        // --- Utility Functions ---
        // Map a value from one range to another
        const mapRange = (value, inMin, inMax, outMin, outMax) => {
            return ((value - inMin) * (outMax - outMin)) / (inMax - inMin) + outMin;
        };

        // Find intersection of two lines
        const lineIntersection = (p1, p2, p3, p4) => {
            const d = (p1.x - p2.x) * (p3.y - p4.y) - (p1.y - p2.y) * (p3.x - p4.x);
            if (d === 0) return null;
            const t = ((p1.x - p3.x) * (p3.y - p4.y) - (p1.y - p3.y) * (p3.x - p4.x)) / d;
            const u = -((p1.x - p2.x) * (p1.y - p3.y) - (p1.y - p2.y) * (p1.x - p3.x)) / d;
            // Allow intersection beyond segments by removing t and u checks
            return { x: p1.x + t * (p2.x - p1.x), y: p1.y + t * (p2.y - p1.y) };
        };
        
        // --- Drawing Functions ---
        const drawScale = (scale) => {
            ctx.beginPath();
            ctx.moveTo(scale.x, config.padding.top);
            ctx.lineTo(scale.x, canvasHeight - config.padding.bottom);
            ctx.strokeStyle = config.lineColor;
            ctx.lineWidth = 1;
            ctx.stroke();

            // Label
            ctx.fillStyle = config.textColor;
            ctx.font = config.labelFont;
            ctx.textAlign = 'center';
            ctx.fillText(scale.label, scale.x, config.padding.top - 30);
            ctx.fillText(`(${scale.id})`, scale.x, config.padding.top - 15);

            // Ticks and Values
            ctx.font = config.font;
            scale.ticks.forEach(tick => {
                const y = mapRange(tick.value, scale.min, scale.max, canvasHeight - config.padding.bottom, config.padding.top);
                ctx.beginPath();
                ctx.moveTo(scale.x - 5, y);
                ctx.lineTo(scale.x + 5, y);
                ctx.strokeStyle = config.tickColor;
                ctx.stroke();
                ctx.textAlign = tick.align === 'left' ? 'right' : 'left';
                ctx.fillText(tick.label, scale.x + (tick.align === 'left' ? -10 : 10), y + 4);
            });
        };
        
        const drawPivot = (scale) => {
             ctx.beginPath();
            ctx.moveTo(scale.x, config.padding.top);
            ctx.lineTo(scale.x, canvasHeight - config.padding.bottom);
            ctx.strokeStyle = config.pivotColor;
            ctx.lineWidth = 2;
            ctx.stroke();

            ctx.fillStyle = config.pivotColor;
            ctx.font = config.labelFont;
            ctx.textAlign = 'center';
            ctx.fillText(scale.label, scale.x, config.padding.top - 30);
            ctx.fillText(`(${scale.id})`, scale.x, config.padding.top - 15);
        };

        const drawMarker = (point, color = config.markerColor, size = 4) => {
            ctx.beginPath();
            ctx.arc(point.x, point.y, size, 0, 2 * Math.PI);
            ctx.fillStyle = color;
            ctx.fill();
        };

        // Main drawing function
        const drawNomograph = () => {
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);
            Object.values(scales).forEach(scale => {
                if (scale.isPivot) {
                    drawPivot(scale);
                } else {
                    drawScale(scale);
                }
            });
        };

        // --- Calculation and Update Logic ---
        const update = () => {
            // 1. Get values from sliders
            const vpd = parseFloat(vpdSlider.value);
            const nozzle64ths = parseFloat(nozzleSlider.value);
            const pressure = parseFloat(pressureSlider.value);
            const wind = parseFloat(windSlider.value);

            // 2. Update display values
            vpdValueSpan.textContent = `${vpd.toFixed(2)} psi`;
            nozzleValueSpan.textContent = `${nozzle64ths}/64"`;
            pressureValueSpan.textContent = `${pressure.toFixed(0)} psi`;
            windValueSpan.textContent = `${wind.toFixed(0)} mph`;

            // 3. Redraw the base nomograph
            drawNomograph();

            // 4. Calculate point positions on scales
            const pVPD = { x: scales[3].x, y: mapRange(vpd, scales[3].min, scales[3].max, canvasHeight - config.padding.bottom, config.padding.top) };
            const pNozzle = { x: scales[5].x, y: mapRange(nozzle64ths, scales[5].min, scales[5].max, canvasHeight - config.padding.bottom, config.padding.top) };
            const pPressure = { x: scales[7].x, y: mapRange(pressure, scales[7].min, scales[7].max, canvasHeight - config.padding.bottom, config.padding.top) };
            const pWind = { x: scales[9].x, y: mapRange(wind, scales[9].min, scales[9].max, canvasHeight - config.padding.bottom, config.padding.top) };

            // 5. Calculate intersection points based on the nomograph's visual logic
            // Line 1: Connects VPD(3) and Nozzle(5), intersects Pivot A(4)
            const p4Line = { p1: { x: scales[4].x, y: 0 }, p2: { x: scales[4].x, y: canvasHeight } };
            const pA_intersect = lineIntersection(pVPD, pNozzle, p4Line.p1, p4Line.p2);

            // Line 2: Connects Pressure(7) and Wind(9), intersects Pivot B(8)
            const p8Line = { p1: { x: scales[8].x, y: 0 }, p2: { x: scales[8].x, y: canvasHeight } };
            const pB_intersect = lineIntersection(pPressure, pWind, p8Line.p1, p8Line.p2);
            
            // Line 3: Connects Pivot A and Pivot B, intersects Loss(6)
            const p6Line = { p1: { x: scales[6].x, y: 0 }, p2: { x: scales[6].x, y: canvasHeight } };
            let pLoss_intersect = null;
            if (pA_intersect && pB_intersect) {
                pLoss_intersect = lineIntersection(pA_intersect, pB_intersect, p6Line.p1, p6Line.p2);
            }

            // 6. Draw the lines and markers
            ctx.lineWidth = 2;
            
            // Line 1 (VPD -> Nozzle)
            ctx.beginPath();
            ctx.moveTo(pVPD.x, pVPD.y);
            ctx.lineTo(pNozzle.x, pNozzle.y);
            ctx.setLineDash([5, 5]);
            ctx.strokeStyle = config.line1Color;
            ctx.stroke();

            // Line 2 (Pressure -> Wind)
            ctx.beginPath();
            ctx.moveTo(pPressure.x, pPressure.y);
            ctx.lineTo(pWind.x, pWind.y);
            ctx.setLineDash([]);
            ctx.strokeStyle = config.line2Color;
            ctx.stroke();

            // Line 3 (Pivot A -> Pivot B)
            if (pA_intersect && pB_intersect) {
                ctx.beginPath();
                ctx.moveTo(pA_intersect.x, pA_intersect.y);
                ctx.lineTo(pB_intersect.x, pB_intersect.y);
                ctx.strokeStyle = config.line3Color;
                ctx.stroke();
            }

            // Draw markers
            drawMarker(pVPD);
            drawMarker(pNozzle);
            drawMarker(pPressure);
            drawMarker(pWind);
            if(pA_intersect) drawMarker(pA_intersect, config.line1Color, 5);
            if(pB_intersect) drawMarker(pB_intersect, config.line2Color, 5);
            if(pLoss_intersect) drawMarker(pLoss_intersect, config.line3Color, 6);


            // 7. Calculate and display the final result
            if (pLoss_intersect) {
                const lossValue = mapRange(pLoss_intersect.y, canvasHeight - config.padding.bottom, config.padding.top, scales[6].min, scales[6].max);
                resultText.textContent = `${Math.max(0, lossValue).toFixed(1)}%`;
            } else {
                resultText.textContent = 'N/A';
            }
        };

        // --- Initialization ---
        const init = () => {
            // Set canvas size
            const dpr = window.devicePixelRatio || 1;
            const rect = parentDiv.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            canvas.style.width = `${rect.width}px`;
            canvas.style.height = `${rect.height}px`;

            canvasWidth = rect.width;
            canvasHeight = rect.height;

            // Define scale positions and properties based on relative inch distances
            const distances = {
                '3-4': 1.875,
                '4-5': 1.625,
                '5-6': 0.375,
                '6-7': 2.0,
                '7-8': 1.0,
                '8-9': 1.0
            };
            const totalDistance = Object.values(distances).reduce((a, b) => a + b, 0);
            const totalWidth = canvasWidth - config.padding.left - config.padding.right;

            const x3 = config.padding.left;
            const x4 = x3 + (distances['3-4'] / totalDistance) * totalWidth;
            const x5 = x4 + (distances['4-5'] / totalDistance) * totalWidth;
            const x6 = x5 + (distances['5-6'] / totalDistance) * totalWidth;
            const x7 = x6 + (distances['6-7'] / totalDistance) * totalWidth;
            const x8 = x7 + (distances['7-8'] / totalDistance) * totalWidth;
            const x9 = x8 + (distances['8-9'] / totalDistance) * totalWidth;


            scales = {
                3: { id: 3, label: 'VAPOR-PRESS. DEFICIT', x: x3, min: 0, max: 1.0, ticks: [{value: 0, label: '0.0'}, {value: 0.2, label: '0.2'}, {value: 0.4, label: '0.4'}, {value: 0.6, label: '0.6'}, {value: 0.8, label: '0.8'}, {value: 1.0, label: '1.0'}] },
                4: { id: 4, label: 'PIVOT', x: x4, isPivot: true },
                5: { id: 5, label: 'NOZZLE DIA. (64th IN)', x: x5, min: 8, max: 64, ticks: [{value: 8, label: '8'}, {value: 12, label: '12'}, {value: 16, label: '16'}, {value: 24, label: '24'}, {value: 32, label: '32'}, {value: 48, label: '48'}, {value: 64, label: '64'}] },
                6: { id: 6, label: '% EVAPORATION LOSS', x: x6, min: 0, max: 40, ticks: [{value: 0, label: '0'}, {value: 1, label: '1'}, {value: 2, label: '2'}, {value: 3, label: '3'}, {value: 4, label: '4'}, {value: 5, label: '5'}, {value: 10, label: '10'}, {value: 15, label: '15'}, {value: 20, label: '20'}, {value: 30, label: '30'}, {value: 40, label: '40'}] },
                7: { id: 7, label: 'NOZZLE PRESS. PSI', x: x7, min: 20, max: 80, ticks: [{value: 20, label: '20'}, {value: 25, label: '25'}, {value: 30, label: '30'}, {value: 40, label: '40'}, {value: 50, label: '50'}, {value: 60, label: '60'}, {value: 70, label: '70'}, {value: 80, label: '80'}] },
                8: { id: 8, label: 'PIVOT', x: x8, isPivot: true },
                9: { id: 9, label: 'WIND VELOCITY, MPH', x: x9, min: 0, max: 15, ticks: [{value: 0, label: '0'}, {value: 2, label: '2'}, {value: 4, label: '4'}, {value: 6, label: '6'}, {value: 8, label: '8'}, {value: 10, label: '10'}, {value: 12, label: '12'}, {value: 14, label: '14'}] },
            };
            
            // Set tick alignment
            Object.values(scales).forEach(s => {
                if (s.ticks) s.ticks.forEach(t => t.align = 'right');
            });
            scales[6].ticks.forEach(t => t.align = 'left');
            scales[9].ticks.forEach(t => t.align = 'left');

            update();
        };

        // --- Event Listeners ---
        [vpdSlider, nozzleSlider, pressureSlider, windSlider].forEach(slider => {
            slider.addEventListener('input', update);
        });

        window.addEventListener('resize', init);

        // --- Initial Load ---
        // Set initial values from example
        vpdSlider.value = 0.6; // Approximated from original example's temp/humidity
        nozzleSlider.value = 12; // 3/16" = 12/64"
        pressureSlider.value = 40;
        windSlider.value = 5;
        
        init();
    </script>
</body>
</html>
